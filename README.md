Bosh & Concourse
================

WARNING: This is not a supported tool, use it at your own risk !

Bosh & Concourse (or bnc) is yet another tool to deploy Bosh and
Concourse (with UAA and Credhub).

But why ? don't we already have tools to do that ? Well yes. Bnc is
just a short bash script that wraps BOSH BootLoader (bbl). Bbl is the
fastest way I could find to have a Bosh running on my IaaS provider.
But when it comes to deploy Concourse, there are still a couple of
[manual steps to be performed][1]. Bnc just does that in a script
(`bnc.sh`).

Also it provides a Dockerfile, that builds a container with all the
tooling required to run Bnc (including Bosh, Terraform, Bbl and
Bnc). This container is automatically built and available as
`fflament/bnc` (i,e `docker run fflament/bnc` should work out of the
box).


Prerequisite
============

The easiest/fastest way to get all the dependencies required to run
`bnc.sh` is by using the `fflament/bnc` docker container, built from
the `Dockerfile` available in this repository. For the remaining of
this document, it is assumed that the user is launching the commands
from inside the `fflament/bnc` docker container. For example, one can
do so by running the following command from the directory where the
`bbl` state is to be generated:

```
$ docker run --rm -it -v ${PWD}:/work fflament/bnc
```

An alternative approach would be to install every required software on
one's machine. See the [Dockerfile][6] to have the details about the
requirements.


How to use
==========

`bnc.sh` needs to be launched in the "bbl state directory" (an
initially empty directory, which will be populated with the files
generated by bbl). It fully relies on 2 configuration files, plus the
IaaS credentials file dedicated to bnc/bbl, obtained from the IaaS
provider (either through the web UI or from the CLI).

The 2 files to be written are:

* `envrc`
* `vars/concourse-vars-file.yml`

`envrc` exports the [environment variables required by bbl][4]. For
example:

```
export BBL_IAAS=gcp
export BBL_GCP_REGION=europe-west1
export BBL_GCP_SERVICE_ACCOUNT_KEY=<path-to-gcp-service-account-key>
```

`vars/concourse-vars-file.yml` defines all [the variables to be used
be the Concourse deployment manifest][1], except `external_host` and
`external_url`. These latest variables are automatically provided by
the script. For example:

```
local_user:
  username: "admin"
  password: <your-secure-password>
network_name: 'private'
web_instances: 1
web_network_name: 'private'
web_vm_type: 'default'
web_network_vm_extension: 'lb'
db_vm_type: 'default'
db_persistent_disk_type: '1GB'
worker_instances: 2
worker_vm_type: 'default'
worker_ephemeral_disk: '50GB_ephemeral_disk'
deployment_name: 'concourse'
```

Once these 2 configuration files have been written, bnc can be
launched:

```
$ bnc.sh
```

The URL to be used to connect to Concourse is displayed by the script
when it finishes. It can also be retrieved with the following command:

```
$ terraform output -state vars/terraform.tfstate concourse_lb_ip
```

To use the bosh CLI, the `bbl print-env` [command][5] can be used to
provide the environment variables required by `bosh`:

```
$ eval "$(bbl print-env)"
```

Tearing down the platform:

```
$ eval "$(bbl print-env)" \
  && source envrc \
  && bosh -n -d concourse delete-deployment \
  && bbl -n down
```


Notes
=====

Bnc currently only works with GCP.

Related tools:
* [bosh-bootloader][2]
* [BUCC][3]


[1]: https://github.com/cloudfoundry/bosh-bootloader/blob/master/docs/concourse.md
[2]: https://github.com/cloudfoundry/bosh-bootloader
[3]: https://github.com/starkandwayne/bucc
[4]: https://github.com/cloudfoundry/bosh-bootloader/blob/master/docs/getting-started-gcp.md
[5]: https://github.com/cloudfoundry/bosh-bootloader/blob/master/docs/howto-target-bosh-director.md
[6]: https://github.com/FlorentFlament/bosh-n-concourse/blob/master/Dockerfile
